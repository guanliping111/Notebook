## OSI七层协议

```
应用层：文件传输，常用协议HTTP，snmp, FTP ,
表示层：数据格式化，代码转换，数据加密，
会话层：建立，解除会话
传输层：提供端对端的接口，TCP, UDP
网络层：为数据包选择路由，IP，icmp
数据链路层：传输有地址的帧
物理层：二进制的数据形式在物理媒体上传输数据
```

**传输层**：重要作用,就是指定通信端口。服务器指定用什么协议。如80端口，就是想用HTTP协议

**具有代表性的协议： `TCP` 与 `UDP`**：

1. TCP: 提供可靠的通信传输，确认目标能通信的情况下才会传输数据(因此需要三次握手)。传输过程数据包丢失会重发。

   TCP头提供用于排序的序列号，用来保证把乱序的数据包组合成一个完整的文件

   TCP提供了一种可靠、面向连接、字节流、传输层的服务，采用三次握手建立一个连接。采用4次挥手来关闭一个连接。

   "连接"：在发送数据前，通信双方会建立一条连接，客户端和服务端的内存里保存的一份关于对方的信息，(如 IP地址、端口号)

2. UDP: 不可靠传输。不会确认目标能否通信，只会根据协议发送到对方的端口。不管数据对方是否收到或者丢失。所以数据包易丢失，而且UDP也不知道如何组装这些数据包


作比喻的话，可以将传输层看作是快递公司的跟单员。负责任的跟单员（使用 `TCP` 协议）会保证快递送到客户手上，如果送不到就让公司再发一次。不负责任的跟单员（使用 `UDP` 协议）层只管将快递送到客户指定的地方，不管快递是否送到客户手上。

对比：

|              | UDP                                        | TCP                                    |
| ------------ | ------------------------------------------ | -------------------------------------- |
| 是否连接     | 无连接                                     | 面向连接                               |
| 是否可靠     | 不可靠传输，不使用流量控制和拥塞控制       | 可靠传输，使用流量控制和拥塞控制       |
| 连接对象个数 | 支持一对一，一对多，多对一和多对多交互通信 | 只能是一对一通信                       |
| 传输方式     | 面向报文                                   | 面向字节流                             |
| 首部开销     | 首部开销小，仅8字节                        | 首部最小20字节，最大60字节             |
| 适用场景     | 适用于实时应用（IP电话、视频会议、直播等） | 适用于要求可靠传输的应用，例如文件传输 |

### TCP连接

#### 三次握手

- 第一次握手：浏览器发给服务器，告诉服务器，我将要发送请求
- 第二次握手：服务器发送浏览器，告诉浏览器，我准备好了，你放马过来
- 第三次握手：浏览器发送服务器，告诉浏览器，我来了

1. 三次握手是客户端和服务端相互发送三个数据包，以确认双方的发送能力和接收能力

   从最开始双方都处于CLOSED状态。然后服务端开始监听某个端口，进入了LISTEN状态。

   然后客户端主动发起连接，发送 同步标志位SYN , 自己变成了SYN-SENT状态。

   服务端接收到，返回SYN和ACK(对应客户端发来的SYN)，自己变成了SYN-REVD。

   之后客户端再发送ACK给服务端，自己变成了ESTABLISHED状态；服务端收到ACK之后，也变成了ESTABLISHED状态。

2. 凡是需要对端确认的，一定消耗TCP报文的序列号。

3. 最后客户端还要发送一次的原因是：防止已经失效的连接请求报文突然又传到了服务端，产生错误

-  [02.浏览器渲染过程.md](02.浏览器渲染过程.md) 为啥不是两次 ：无法确认客户端的接受能力

- 不是四次：三次已经达到需求了

- 三次握手可以携带数据嘛

  前两次不行，前两次传输如果携带数据的话，服务端要花费大量时间处理这些数据

  第三次握手的时候，客户端已经处于ESTABLISHED状态，并且已经能够确认服务器的接收、发送能力正常，这个时候相对安全了，可以携带数据。

#### 断开连接（四次挥手）

TCP四次挥手（浏览器挥手两次，服务器挥手两次。 断开请求需要两次挥手, 断开响应需要两次挥手）
  第一次挥手：浏览器发送服务器，告诉服务器，我东西（请求报文）发完了，服务器准备关闭
  第二次挥手：服务器发送浏览器，告诉浏览器，我东西接受完了，我准备关闭，你也准备关闭
  第三次挥手：服务器发送浏览器，告诉浏览器，我东西（响应报文）发完了，浏览器准备关闭
  第四次挥手：浏览器发送服务器，告诉服务器，我东西接受完了，我准备关闭，你也准备关闭